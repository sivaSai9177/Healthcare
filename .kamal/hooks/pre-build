#!/bin/bash
# Pre-build hook - Run before building Docker images

echo "ğŸ—ï¸  Pre-build: Preparing for Docker build..."

# Ensure .env file exists
if [ ! -f .env ]; then
    echo "âš ï¸  Warning: .env file not found, using .env.example"
    cp .env.example .env
fi

# Generate build timestamp
BUILD_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
echo "BUILD_TIMESTAMP=${BUILD_TIMESTAMP}" >> .env

# Ensure database migrations are up to date
echo "ğŸ“ Generating database migrations..."
bun run db:generate || {
    echo "âŒ Failed to generate database migrations"
    exit 1
}

# Run tests before building
echo "ğŸ§ª Running tests..."
bun test || {
    echo "âŒ Tests failed. Fix errors before deployment."
    exit 1
}

# Check for TypeScript errors
echo "ğŸ” Checking TypeScript..."
bun run typecheck || {
    echo "âŒ TypeScript errors found. Fix before deployment."
    exit 1
}

echo "âœ… Pre-build checks completed successfully!"