#!/bin/bash
# Post-deploy hook - Run after successful deployment

echo "ğŸ‰ Post-deploy: Finalizing deployment..."

# Run database migrations
echo "ğŸ“ Running database migrations..."
ssh "root@${DEPLOY_SERVER_IP}" "docker exec healthcare-app bun run db:push" || {
    echo "âŒ Failed to run migrations"
    exit 1
}

# Warm up the application
echo "ğŸ”¥ Warming up application..."
curl -s -o /dev/null -w "%{http_code}" "https://${DEPLOY_DOMAIN}/api/health" || {
    echo "âš ï¸  Warning: Health check failed"
}

# Clear CDN cache if applicable
echo "ğŸ§¹ Clearing caches..."
# Add CDN cache clearing commands here if using a CDN

# Send deployment notification
echo "ğŸ“¢ Sending deployment notification..."
if [ -n "$SLACK_WEBHOOK_URL" ]; then
    curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"ğŸš€ Healthcare Alert System deployed successfully to ${DEPLOY_DOMAIN}\"}" \
        "$SLACK_WEBHOOK_URL"
fi

# Log deployment
echo "ğŸ“Š Logging deployment..."
DEPLOY_TIMESTAMP=$(date -u +%Y-%m-%d_%H:%M:%S_UTC)
echo "[${DEPLOY_TIMESTAMP}] Deployment completed for version ${KAMAL_VERSION}" >> /var/log/healthcare-deployments.log

echo "âœ… Post-deploy tasks completed!"
echo "ğŸŒ Application is now live at: https://${DEPLOY_DOMAIN}"